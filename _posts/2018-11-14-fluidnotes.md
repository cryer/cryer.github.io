---
layout: post
title: 流体仿真-基础篇
description: 主要是根据大名鼎鼎的course notes整理的笔记
---


# 前言

  主要是根据Robert Bridson著名的Course Notes，个人写的笔记整理，补充上一些我认为不够清晰的地方。可能分成几个部分，首先先整理基础篇，
  从基本的流体力学方程入手，解释每一项的具体含义，以及原理，然后针对不同的流体特性对方程进行简化，而且NS方程目前还没有人能够求出解析解，
  只有100多个特解，因此只能采用数值上的近似方法，所以接下来会进入数值分析该方程的步骤，近似求解方程，解出速度场，然后进行流体的模拟仿真。
  需要有一定的数学基础：微积分，向量分析，微分方程数值分析等。


## 流体力学方程

  要进行流体仿真，首先就要搞清楚流体所遵循的物理定律，也就是力学方程，然后才能进行准确的模拟。流体力学中关于流体最重要的方程就是纳维-斯托克斯方程，
  也就是NS方程，具体定义如下：
  
  ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/1.png)
  
  该方程由两部分组成，一式是动量方程，二式是质量守恒方程，接下来一一解释。在解释之前，先把符号含义定义，u向量指的是流体的速度，p是压强，g向量是重力加速度，
   ρ 是流体的密度，希腊字母ν称为运动粘度。
   
   ```
   由于表达不方便，文中的大部分向量的箭头标志我都省略，比如u，a，g，F等等。
   ```
  
  
### 动量方程

   
   动量方程指的就是一式，乍一看很复杂，其实就是牛顿第二定律，也就是外力的大小等于动量的变化率，或者说F=ma。首先a就是加速度，
   应该等于速度对时间的导数Du/Dt，这里的大D指的是全导数，在流体力学里，这个导数也叫作物质导数或者随体导数。后面会说到
   这个随体导数其实是在拉格朗日方法中用到的，随体就表示跟随物体，先不讨论。
   
   根据牛顿第二定律，ma=F，a用随体导数替换，也就是mDu/Dt=F，m是流体微团的质量，这里用微团表示我们所关注的流体小部分，这是流体力学中经常
   用到的术语。F就是这个微团所受的外力，那么显然，这个外力具体是什么就是接下来的目标。
   
   * 首先比较清晰的是重力，也就是mg，这个微团肯定是会受到重力的
   * 然后是压力，不同的流体微团之间一定会存在压力，压力高的区域挤压压力低的区域，解决压力的问题也是流体仿真中非常非常重要的一部分。那么压力是什么呢？
   压强其实就是压力场的差，压力场的差也就是压力场的梯度，所以我们可以简单的用压力场的梯度的负方向−∇p表示压强，压力就是压强在这个流体微团体积上的积分，
   一般为了简单起见，而且我们假设流体微团足够小，可以直接乘以这个体积近似整个微团的压力，也就是-V*∇p
   * 然后要考虑的就是粘性力，流体之间是有粘性的，区别只是粘性的大小不同，比如蜂蜜的粘性很大，平时的自来水粘性小一些。为了数学建模，粘性从另一方面看
   其实就是为了让当前的流体微团和周围的流体微团的速度相似，即周围流体微团的平均速度。这用拉普拉斯算子来描述在准确不过了，拉普拉斯就是描述了
   与周围平均速度差别的算子，为0时，和周围平均速度一致。拉普拉斯算子记为∇ · ∇，也可以记为∇的平方，其实也就是梯度的散度，展开来说就是空间的二阶导数。
  在向量分析领域，拉普拉斯算子有很重要的意义。和压力一样，为了得到整个微团的粘度，必须对体积积分，也可以简单的乘以体积近似，即V*∇ · ∇u。但是这样衡量不了
  不同粘性流体的区别，因此还需要加上一个动力粘性系数 µ。
  
  把上面的三个外力组合起来可以得到整个流体微团的动量方程：
  
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/2.png)
 
 这个方程要想没有错误，必须取极限，也就是微团数目趋向于无穷多，并且每个流体微团的大小尺寸趋向于0才行，不然这个方程就是错误的。现在有一个问题
 出现了，如果取了极限，那么为微团的重量m和体积V也同样趋向于0了，这就无法计算了，我么可以方程两侧同时除以V，把m和V替换成密度：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/3.png)
 
 现在看起来和一开始给出的NS方程中的动量方程就有点相似了，左右再同时除以密度并且整理一下得到：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/4.png)
 
 为了进一步简化方程，定义ν = µ/ρ，将动力粘性系数除以密度的商定义为动力学粘度ν，得到：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/5.png)
 
 现在看来和NS动量方程更加接近了，唯一的区别就是Du/Dt，也就是我们先前说到的随体导数，下面我们将理解随体导数具体是什么，有什么意义。
 
 
### 拉格朗日描述和欧拉描述

 
 在前面说到随体导数的时候我说道这是在拉格朗日法中用到的，指的就是这里的拉格朗日描述。何为拉格朗日描述？就是把流体看成一个个的粒子组成，
 也可以吧前面的流体微团看成粒子，每个粒子单独拥有自己的属性，包括位置x，速度u等，这个描述和我们对流体的直观理解更加接近，实现起来也较为
 容易，但是缺点是流体粒子之间的交互变得复杂了起来，因为每个粒子都是独立的。而随体导数描述的就是一个量随着时间的变化率，这里不特地指定这个量是
 速度u，更加一般化了，也可以是温度之类的，恰好符合拉格朗日的描述，而拉格朗日法的一大好处就是由于粒子的数目是固定的，因此NS方程中的质量守恒
 方程是自动满足的。
 
 欧拉描述则是一个新的视角，他不把流体看成粒子系统，不会追踪每个粒子，而是只观察空间中的特定的固定点，观察这个点的属性随时间的变化，而这个
 固定点属性的变化是由流体流过而改变的，欧拉描述和人们的直观印象相对不是很符合，但是他也有很多的优点：
 * 更容易处理空间导数，比如压力梯度和粘性的拉普拉斯算子，只需要利用空间点的有限差分即可，而粒子系统比较混乱，难以计算
 * 欧拉网格上近似空间导数比随机移动的粒子方便多了

因此不同于拉格朗日描述遵循的质量守恒，欧拉描述遵循的是体积守恒。

```
其实还有一种LBM法，从微观力学的角度考虑，但是笔记中没有提到，也不再多说
```
 
 而拉格朗日法和欧拉法就是通过随体导数相关联的。为了一般化，我们取一个一般的量q，他关于时间t和位置x，即q(t,x)，不同时间不同位置q值不同。
 现在求q对时间的全导数：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/6.png)
 
 我们可以发现，q对时间点额全导数就是随体导数，这在开始我也提到了，他是在拉格朗日描述中用到的，展开后发现包含了q对时间的偏导，这是与x无关的，
 也就是说x是常数，这个偏导代表了q和常数x位置随时间的变化，正好满足了欧拉描述。而剩下一项是一个修正项，与流过这个固定点的流体有关。组合起来就是
 拉格朗日描述就是欧拉描述加上经过欧拉网格点的流体带来的属性变化。
 
 为了完整，我给出随体导数在三维上的完整形式：
 
  ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/7.png)
  
  随体导数可以用来表示平流或者说对流，在流体力学中随体导数的那一项也叫作对流项。所谓对流，或者说平流，就是一个量在一个速度场中被速度场输送的过程。
  这一般很好理解，但是当这个量也是速度的时候可能会产生一些混乱，不仅是温度之类的可以再速度场中平流，速度本身也是可以的。
  一般我们取随体导数为0，就是一个简单的平流方程，他表示这个量仅仅在速度场中到处移动，在拉格朗日的视角下，他没有任何变化，即他的温度，速度等没有变化。
  但是在欧拉视角下，可能发生了变化。可以举一个简单的例子：
  ```
  一个一维空间上，不同位置的温度不同，满足T(x)=10x,即x=10处的温度为100.现在这个空间置身于一个流速稳定的速度场中，也就是u=c，是一个常量。
  令DT/Dt=0，解这个平流方程(全导数展开即可)，得到T对t的偏导数为-10c，这意味着对于欧拉描述来说，空间上的某个固定点的温度和速度场的速度大小和
  方向有关。如果c=0，则每一处的温度不变，若风从正方向以c=2吹过，这点的温度将以20的速度上升，下降亦然。
 ```
 
### 不可压缩性

 
 自然界中可压缩流体的仿真很复杂，而且很不常见，所以我们可以只考虑不可压缩流体。而且即使是可压缩的流体，也不太可能发生很大体积的改变，因此我们可以视为
 不可压缩。不可压缩，另一个角度来看就是体积不会改变，密度不会改变，假设一个流体微团，表面为∂Ω，体积为Ω，则我们可以定义这个微团的体积变化率为：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/8.png)
 
体积的变化率等于每小块表面速度法向部分在整个面上的积分，面积分结果大于0，代表总体体积变大，向外的速度大于向内的速度，微团被拉伸。为了得到不可压缩流体，
因此需要满足这个面积分的结果为0.

 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/9.png)

再根据散度定理，把微团面积分转化为整个微团的体积分(关于散度定理不展开，就是一种将面积分转化为体积分的方式，类比格林公式)：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/10.png)
 
 观察到对任意的Ω而言，也就是流体的任意区域，这个方程都应该成立，唯一满足这个条件的函数就只能是0了，因此得到∇ · u = 0，注意到这就是NS方程
 中的二式，我们一开始称为质量守恒方程，其实同时也是不可压缩条件，正因为不可压缩，所以体积不变，然后才能保证质量也不变。满足这个不可压缩条件的向量场
 我们称为“散度自由”或者“零散度”。事实上，仿真不可压缩流体最重要的就是要保证流体时刻处于零散度状态。零散度也是压力产生的原因，因为体积保持不变，
 因此微团一面受力，这面体积缩小，为了满足体积不变，另一面体积就要增大，这就产生了对另一面的压力。
 
 
### 舍去粘度

实际上对于大部分场景，粘度项是可以舍去的，一是因为常见的场景下粘度是可以忽略的，现实大部分流体都可以看成非粘性不可压缩流体；二是因为
我们会用数值的方法来求解NS方程，这实际上会引入叫“数值耗散”的问题，也就是误差，后面也会分析这个误差其实就是关于速度的空间二阶导数，
空间二阶导数其实就是拉普拉斯算子，所以实际上不可抗的我们都会引入粘度项，或者叫类粘度项，因此公式中的粘度可以显式的舍去。
 
 舍去粘度项的NS方程，我们叫做欧拉方程：
 
  ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/11.png)
  
  接下来我们主要解决欧拉方程，使用欧拉描述的方式，后面也会介绍SPH这种拉格朗日描述的算法。
 
### 边界条件
 
流体仿真最重要的一部分是边界条件，在计算流体力学这个领域中，大部分的精力都花在边界条件上。我们之前一直在讨论流体的内部情况，没有涉及
流体的边界问题，比如流体和固体墙的交互，再比如流体表面和空气的交互，这两个也是最重要的交互，还有一种是不同流体之间的交互，比如蜂蜜和水
的交互，这个就复杂很多了，暂时不在考虑范围内。

所以我们主要讨论“固体墙”和“自由面”两种情况：

#### 固体墙

流体和固体墙的交互，有两种情况，一种固体墙是完全固定的，那么为了不让流体穿过固体，可以简单的将边界的速度法向分量设置为0，即：

 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/12.png)
 
 另一种情况是固体是移动的，也就是固体本身也有一个速度，那么我们就可以令边界法向速度分量等于固体的速度，让流体跟随固体而走，
 我们没有限制切向速度，因此流体可以自由的沿着固体边界切向滑动，这也是符合实际情况的。
 
  ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/13.png)
  
 ```
 注意到我们讨论的非粘性流体，如果是粘性流体的话，固体墙的粘性对流体的切向的速度分量也是有影响的
 ```
  
  另外对于某些特殊的固体墙，比如通风口或者排水管，我们需要特殊处理，不会直接让速度法相分量等于固体的速度，而且赋予抽水泵汲取或者喷出的
  速度。
  
 #### 自由面
 
自由面就是我们终止流体模拟的地方，比如水的表面，这时候需要考虑空气，但是因为空气比水轻700多倍，因此可以把空气看成拥有大气压强的一片区域，在实际仿真中
我们只关心压力差，可以简单的把大气压设置为0，即自由面是压强为0的面。
 
液体表面有时还有一种特殊情况需要考虑，就是水的表面张力。从分子层面来看，表面张力的成因是因为液体分子之间的吸引力大于水分子和空气各分子之间的吸引力
造成的。为了数学上的建模，可以从几何角度来看，表面张力就是尽力最小化水的表面面积，或者换一种说法，尽量减少表面的平均曲率，我们使用
第二种表述来进行建模。

如下公式是成立的，表面之间的压力跃变正比于表面的平均曲率，即：

 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/14.png)
  
 
 其中的 γ 是表面张力系数，已经有精确的物理测量结果了，常温下，水和空气的γ ≈ 0.073N/m。换种说法，
 you表面张力的自由面，书表面的压力就是空气压力(通常假设为0)加上压力跃变。
 
 
## 数值近似

上面已经基本很详细的剖析了NS方程各项的意义和背后的数学建模原理，以及针对常见流体，也就是非粘性不可压缩流体的简化形式，
然而即使经过简化，变成了欧拉方程，解决起来依然不是很简单，无法求出解析解，因此流体仿真一般采用数值近似的方式。
  
数值近似直接解决整个欧拉方程是很复杂的，因此一般采取分治法的思想，分而治之，把欧拉方程分离成几个部分分别解决，
然后再结合起来，这在数学上是合理的，假设：

![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/15.png)
 
 这里f和g函数可以是任意的黑盒子函数代表分离的部分，我们可以将这个微分方程使用显式欧拉分离成：
 
![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/16.png)
 
 这个分离是一个一阶精确算法，可以泰勒展开验证一下：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/17.png)
 
 正如你看到的这样，原来的微分方程被分离成两个单独的方程，一个只包含f函数，一个只包含g函数。需要注意的是
 分离后的方程的解决顺序也有讲究，一般顺序解决，因为有的积分器需要另一个积分器的输入，顺序序列能保证不出错，
 并行计算可能发生问题。
 
 ```
 显式欧拉：也叫前向欧拉，是一种常用的微分方程数值近似方法，利用下一步的函数值等于当前函数值加上
 时间步delta乘以当前函数的导数这个关系，f(x+delta) = f(x) + f'(x)*delta,因为向前看了一步，
 所以叫前向欧拉，自然相应的还有后向欧拉，就是向后看一步，后向欧拉
 是前向欧拉的改进方法，是稳定的算法，而前向欧拉是有不稳定区域的，但是后向欧拉复杂了很多。
 ```
 
### 分离欧拉方程

我们同样可以分离欧拉方程，分别解决，一般分为平流部分，体积力部分和压力/不可压缩部分：

![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/18.png)
 
 分开解析一下：
 
 * 平流部分，可以表示成advect(u, ∆t, q)，表示一个量q在速度场u中输送一个∆t的时间步，就是我们之前说到很多次的平流方程。
 * 体积力部分，此处只考虑有重力的情况，浮力之类的体积力也可以合成到重力中。公式表示了重力加速度对流体速度的影响，可以用
 前面解释的显式欧拉法来近似，这是最简单的一部分。
 * 压力部分，表示成project(∆t, u) ，将压力梯度移到方程的右侧就可以看出，这是考虑了压强对速度的影响，同时还要保证
 满足不可压缩条件，这也是保证压强的来源。
 
 一旦我们上述分离后的方程都解决了之后，只需要按如下方式组合起来即可:
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/19.png)
 
 在进入具体方程的数值近似之前，我们先考虑几个问题：
 
 * 时间步的选择，数值近似就是离散化的过程，时间步决定了离散的精度，因此时间步的选择是一个trade-off问题，要兼顾速度和准确度。
 有特殊需要注意的地方，就是时间步不能越过当前动画帧的间隔，也就是不能tn + ∆t > tframe，一般超过，我们需要强制令∆t = tframe − tn，
 同时设置一个标志标明我们到了这一帧的结尾，这是为了进行一些操作，因为每一帧的结尾我们需要渲染到屏幕或者是保存状态。
 
 * 空间离散。之前包括∆t，前向欧拉等等都是在时间上的离散，一个个时间步，现在我们考虑空间上的离散，因为我们使用的是欧拉方法，
 因此空间离散就使用网格(Grid)，以前的很多网格法都是规则网格，也就是所有的数据都存在网格的中心，包括速度，压力等等。这种网格
 会有一些很大的困难，比如解决压力梯度时，会出现null-space，也就是零空间的问题，这个后面会说。我们采用的是MAC网格，这是一种交错网格，
 数据交错存储，不是全存在网格的中心，下面给出两张图，分别是2D和3D的情况，这两张图需要牢记：
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/20.png)
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/21.png) 
 
 可以看到不同的变量保存在不同位置，所以称为交错网格。这种结构的好处就是方便利用差分计算压力梯度和速度场的散度，接下来在相应的
 计算部分会详细介绍。

 ```
 差分计算：有必要先介绍一下差分计算，这也是常见的一种数值近似的方法，和前面的前向欧拉法一样，
 不过前向欧拉一般用于时间上的近似，差分适合空间上的近似，差分法又分为前向差分，
 后向差分和中心差分。举个例子，一维上三个点pi-1,pi,pi+1，求pi出的导数，可以用差分
 近似，前向差分：(pi+1 - pi)/delta ，后向差分：(pi - pi-1)/delta ，中心差分：
 (pi+1 - pi-1)/2*delta，其中前向后向差分有偏差，精确到O(∆x)，中心差分无偏差，
 而且精确到O(∆x2)，所以一般使用中心差分。
 
 但是中心差分有一个问题，就是完全不考虑pi本身的值，中心差分计算为0，本来应该是导数为0，
 也就是说函数是常数，但是中心差分不考虑pi，因此pi可能在任意位置，因此不能保证是常数函数，
 这就是前面说到的null-space问题，零空间问题，这常常是致命的。
 
 解决方案就是使用MAC网格，注意到MAC网格使用中心差分(pi+1/2 - pi−1/2)/2*delta，
 因此没有跳过任何值，所以没有零空间问题。
 
 关于高阶差分问题，这里也简单提一下，一阶中心差分是：p'(i) = (pi+1 - pi−1)/2*delta,
 二阶差分公式是：p''(i) = (pi+1 + pi−1 - 2*pi)/delta平方,至于是如何得到的，主要是
 利用泰勒展开，具体是在x+deltax和x-deltax处泰勒展开，然后俩式相加整理一下就可以得到二阶差分公式，更高阶的也是如此。
 ```
MAC网格主要的缺点是求解空间某处的完整的速度时一定需要插值计算，因为MAC网格把速度各个分量存在了不同的面上，参考上面的图。

### 平流方程

接下来解决实现具体方程的数值近似了，体积力的近似简单的用前向欧拉近似一下就可以了，重点是平流方程和压力方程，这两个解决了，
欧拉方程就解决了，欧拉方程解决了，流体仿真问题就基本解决了。

平流方程就是随体导数为0，前面也说过很多次，表示成advect(u, ∆t, q)，表示了 给定一个速度场u(经过MAC网格离散过得)和δt和
当前的场量qn，求解下一时刻q在速度场中平流输送后的结果。

首先考虑的就是直接暴力解微分方程。
 
 ![](https://github.com/cryer/cryer.github.io/raw/master/image/fluid_base/22.png) 
  
  
  
